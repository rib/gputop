<!-- Pannel 2 -->
<div class = "row">
    <div class = "col-sm-5">
        <h1 id="page-header-metrics">Metrics panel loading</h1>
    </div>
    <div class = "col-sm-6">
        <br>
        <div class="btn-group" role="group" aria-label="...">
            <button type="button" class="btn btn-default" id = "switch_button">Switch to Live Tracing</button>
        </div>
    </div>

</div>

<br> <!-- Ugly, dirty and disgusting way of placing stuff in the right place, will be fixed later -->
<br>

<div class = "container-fluid">
    <div class = "row">
        <div class = "col-sm-8 tab-content" id = "counter_metrics">
        </div>
        <div class = "col-sm-3">
            <ul class="tabs nav nav-pills nav-stacked" id = "sidebar_right" data-tabs="tabs" style="list-style-type:none">
            </ul>
        </div>
    </div>
</div>
<script>
    /*
    function timeout() {
        if (gputop.is_connected_ == true) {
            i += k;
            if (i <= 100)
                setTimeout(timeout, 10);
            else if (i > 100) {
                i = 0;
                setTimeout(timeout, 1000);
            }
        } else {
            i = 0;
            setTimeout(timeout, 1000);
            console.log("Retry timeout");
        }

        $(".bar_adjust").css("width", i + "%");
        $(".progress_text").text(i + "%");
    } // timeout
    */

    function read_metrics_counter() {
        var $counter = $(this);
        var name = $counter.attr("name");
        var symbol_name = $counter.attr("symbol_name");
        //gputop_ui.syslog("Counter name: " + name);

        var counter = gputop.get_counter_by_absolute_id(set_index, counter_index);
        if (counter == undefined) {
            console.log(" Failed to load counter "+ set_index +" "+ counter_index);
            gputop_ui.show_alert("Counter missing, forgot to compile?","alert-danger");
            return;
        }

        if (symbol_name.localeCompare(counter.symbol_name)) {
            gputop_ui.show_alert("Wrong counter mapping, wrong XML vs source code?","alert-danger");
            return;
        }

        var supported_color = "";
        if (!counter.supported_) {
            supported_color='background-color:#e6e6e6;'
        }

        var div_id = 'div_counter_'+set_index + '_' + counter_index;
        var counter_bar_id = 'div_bar_counter_'+set_index + '_' + counter_index;
        var counter_text_bar_id = 'div_txt_'+set_index + '_' + counter_index;

        // display of counter bar metrics
        counter_bars = '\
    <li class = "panel panel-info" style="list-style-type:none;'+supported_color+'" id="'+div_id+' > \
            <div class="row"> \
                <div class = "col-sm-1"> \
                    <div class = "row"> \
                        <div class = "col-sm-2 handle glyphicon glyphicon-move"></div> \
                        <div class = "col-sm-1 live_trace_dropdown"><a role="button" data-toggle="collapse" href="#collapse_graph_' + set_index + '_' + counter_index + '" aria-expanded="false" aria-controls="collapseExample"><div class = "glyphicon glyphicon-collapse-down"></div></a></div> \
                    </div> \
                </div> \
                <div class = "col-sm-3 column_class"><p2 id = "counter">' + name + '</p2></div> \
                <div class = "col-sm-6 overview_bars"> \
                    <div class = "progress"> \
                        <div id ="'+ counter_bar_id +'" class = "progress-bar progress-bar-striped active " role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width:10%; transition: none;" data-toggle="tooltip" data-placement="left"></div> \
                    </div> \
                </div> \
                <div class = "col-sm-1"><p class = "progress_text" id = "' + counter_text_bar_id +'">' + 0 + '</p></div> \
            </div> \
            <div class = "row"> \
                <div class = "col-sm-9"> \
                    <div class="collapse" id="collapse_graph_' + set_index + '_' + counter_index + '"> \
                        <div class="well" id="flotcontainer_' + set_index + '_' + counter_index + '"></div> \
                    </div> \
                </div> \
            </div> \
    </li>';
        //counter.div_ = $(div_id);

        $("#tab_number_" + set_index).append(counter_bars);

        $('#'+counter_bar_id).css("width", "100%");
        $('#'+div_id).data(counter);

        counter.div_id_ = div_id;
        counter.div_bar_id_ = counter_bar_id;
        counter.div_txt_id_ = counter_text_bar_id;

        counter_index ++;
    } // read_metrics_counter


    function read_metrics_set() {
        var $set = $(this);
        var title = $set.attr("name");
        var counter_bars;

        var active = "";
        if (set_index == 0) {
            active = " active";
            $('#page-header-metrics').text(title);
        }

        counter_index = 0;

        // contents of the sidebar menu
        $("#sidebar_right").append('<li class="' + active + '"><a id="set_' + set_index + '" href="#tab_number_' + set_index + '" data-toggle="tab">' + title + '</a></li>');

        // display of metrics tab-pane
        $("#counter_metrics").append('<div class = "tab-pane' + active + '" id = "tab_number_' + set_index + '">');

        $set.find("counter").each(read_metrics_counter);

        $("#counter_metrics").append("</div");

        set_index ++;

    } // read_metrics_set


    function read_from_xml(xml_name) {
        $(xml_name).find("set").each(read_metrics_set);

        $(".glyphicon-collapse-down").hide();

        $('#sidebar_right a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            e.target // newly activated tab
            e.relatedTarget // previous active tab
            $('#page-header-metrics').text(e.target.text);
        });


        $('.collapse').on('shown.bs.collapse', function(e) {
            $('.progress').hide();
            var id = $(e.target).find(".well");
            //graph_start("#" + id.attr("id"));
            graph_array.push(id.attr("id"));
        });

    } // read_from_xml


    function GetData() {
        data.shift();

        while (data.length < totalPoints) {
            var y = Math.random() * 100;
            var temp = [now += updateInterval, y];

            data.push(temp);
        }
    }


    function graph_start(id_plot) {
        GetData();

        dataset = [
            { label: "CPU", data: data }
        ];

        $.plot($(id_plot), dataset, options);

        function update() {
            GetData();

            $.plot($(id_plot), dataset, options)
            setTimeout(update, updateInterval);
        }

        update();
    };



    // index of set + index of active counter forms an unique id for all counters
    var set_index = 0;
    var counter_index = 0;
    var graph_array = [];

    var toggle_mode = 1; // toggle between Overview and Live Tracing metrics
    var i = 0;
    var k = 1;

    $("#switch_button").on("click", function(){
        if (toggle_mode == 1) {
            $("#switch_button").text("Switch to Overview");
            $('.overview_bars, .progress_text').hide();
            $(".glyphicon-collapse-down").show(); // graph dropdown button
        }
        else {
            $("#switch_button").text("Switch to Live Tracing");
            $('.overview_bars, .progress_text').show();
            $(".glyphicon-collapse-down").hide();
        }
        toggle_mode *= -1;
    });

    // read counters from xml file and populate the website
    read_from_xml(gputop.get_metrics_xml());

    // function that makes each counter pane draggable.
    $(function(){
        for (j = 0; j < set_index; j++) {
            $('#tab_number_' + j).sortable({
                handle: '.handle',
                start: function(e, ui) {
                    ui.placeholder.height(ui.item.height());
                }
            });
        }

    });

    // graph settings
    var graph_time = 0;
    $(function() {

	var container = $("#flotcontainer_0_0");

	// Determine how many data points to keep based on the placeholder's initial size;
	// this gives us a nice high-res plot while avoiding more than one point per pixel.

	var maximum = container.outerWidth() / 2 || 300;

	var data = [];
    function getRandomData() {
        //debugger;

        if (data.length) {
            data.shift();
        }

        while (data.length < maximum) {
            var previous = data.length ? data[data.length - 1] : 50;
            var y = Math.random() * 100;
            data.push([graph_time, y < 0 ? 0 : y > 100 ? 100 : y]);
            graph_time++;
        }
    }


	series = [{
		data: getRandomData(),
		lines: {
			fill: true
		},
        color: "#6666ff"
	}];

        var options = {
		grid: {
			borderWidth: 1,
			minBorderMargin: 20,
			labelMargin: 10,
			backgroundColor: {
				colors: ["#fff", "#e4f4f4"]
			},
			margin: {
				top: 8,
				bottom: 20,
				left: 20
			},
            // dont know what this is for?!
			markings: function(axes) {
				var markings = [];
				var xaxis = axes.xaxis;
				for (var x = Math.floor(xaxis.min); x < xaxis.max; x += xaxis.tickSize * 2) {
					markings.push({ xaxis: { from: x, to: x + xaxis.tickSize }, color: "rgba(232, 232, 255, 0.2)" });
				}
				return markings;
			}
		},
		xaxis: {
            show: true,
            ticks: 10
            //min: 0,
            //max: 1000
		},
		yaxis: {
			min: 0,
			max: 110
		},
		legend: {
			show: true
		}
	};

	// Create the demo X and Y axis labels

	var yaxisLabel = $("<br><br><div class='axisLabel yaxisLabel'></div>")
		.text("Response Time (ms)")
		.appendTo(container);

	// Since CSS transforms use the top-left corner of the label as the transform origin,
	// we need to center the y-axis label by shifting it down by half its width.
	// Subtract 20 to factor the chart's bottom margin into the centering.

	yaxisLabel.css("margin-top", yaxisLabel.width() / 2 - 20);

	// Update the random dataset at 25FPS for a smoothly-animating chart

	setInterval(function updateRandom() {
        getRandomData();
        for (var i = 0; i < graph_array.length; ++i)
        {
            var container = "#" + graph_array[i];
            //var plot = $.plot(container, series, options);
    		series[0].data = data;
    		//plot.setData(series);
            //plot.setupGrid();
            $.plot(container, series, options);
    		//plot.draw();
        }
	}, 40);

});

</script>
