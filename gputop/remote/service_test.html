<!DOCTYPE html>
<html>
<head>
<script src="long.min.js"></script>
<script src="bytebuffer.min.js"></script>
<script src="protobuf.min.js"></script>
<script>
    
function generate_uuid()
{
    /* Concise uuid generator from:
     * http://stackoverflow.com/questions/105034/create-guid-uuid-in-javascript
     */
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
	var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8);
	return v.toString(16);
    });
}

if (typeof dcodeIO === 'undefined' || !dcodeIO.ProtoBuf) {
    throw(new Error("ProtoBuf.js is not present."));
}
// Initialize ProtoBuf.js
var ProtoBuf = dcodeIO.ProtoBuf;

var builder = ProtoBuf.loadProtoFile("./gputop.proto");
var Builder = builder.build("gputop");
var Message = builder.build("gputop.Message");

</script>
</head>
<body>
<textarea id="log" style="width: 100%; height: 200px"></textarea><br />
<input type="text" id="text" value="hello world!" /> 
<button onclick="request_features()">GPUTOP__REQUEST__REQ_GET_FEATURES</button>
<button onclick="request_open_query()">GPUTOP__REQUEST__REQ_OPEN_QUERY</button>
<button onclick="request_close_query()">GPUTOP__REQUEST__REQ_CLOSE_QUERY</button>

<script>
var log = document.getElementById("log");
var text = document.getElementById("text");

// Connect to our server: node server.js
var socket = new WebSocket("ws://localhost:7890/gputop/");
socket.binaryType = "arraybuffer"; // We are talking binary

function request_open_query() {
}

function request_close_query() {
}

function request_features() {
    if (socket.readyState == WebSocket.OPEN) {                
        var msg = new Builder.Request();
        
        msg.uuid = generate_uuid();
        msg.get_features = true;
        
        msg.encode();
        socket.send(msg.toArrayBuffer());
        log.value += "Sent: Request "+msg.uuid+"\n";
    } else {
        log.value += "Not connected\n";
    }
}

socket.onopen = function() {
    log.value += "Connected\n";
};

socket.onclose = function() {
    log.value += "Disconnected\n";
};

function handle_perf_message(id, data) {
    
}
            
socket.onmessage = function(evt) {
    try {
        var dv = new DataView(evt.data);
        var msg_type = dv.getUint8(0);

        var data = new Uint8Array(evt.data, 8);
        
        switch(msg_type) {
            case 1: 
                var id = dv.getUint16(4, true /* little endian */);
                handle_perf_message(id, data);
            break;        
            case 2: /* WS_MESSAGE_PROTOBUF */     
                var msg = Message.decode(data);   
                if (msg.features != undefined)         
                    log.value += "Features: "+msg.features.get_cpu_model()+"\n";                    
                if (msg.log != undefined)         
                    log.value += "Features: "+msg.log.log_message()+"\n";                
                                    
            break;
        }
    } catch (err) {
        log.value += "Error: "+err+"\n";
    }
};
/*
setInterval(function(){ 
    send(); 
}, 1000);
*/
log.value = ""; // Clear log on reload
</script>
</body>
</html>
