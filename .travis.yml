sudo: required

services:
    - docker

language: c

os:
    - linux

compiler:
    - gcc

env:
    global:
        # DJDEATH_GH_TOKEN scope=public_repo, for deployment testing
        # on imgui branch. Limited to builds of the rib/gputop repo
        - secure: "DgKbaylcOKYumClt4kzsGZUeP98d0m4jM/mPWq7I9wM78/AOm3y52JRt3w7yWAWLKGLEM2J92TwO75/skpZBIZ8RB1tCJfq+z2AaIXtLL5U/dcwG5ehL51+3whMjlOYe+HBMnKpguJWaVjUC9HBfwF8S1Ibkgxh6wcdIBY4/tFxjB3E4COxaYpsbaWUnmpmyItmIYGBH1S4fsgxZW1v45Hs2U/943DKot8LRwkuiU9L3W7plMBVTqt+/qhGjXKwN0Zb1XgjbGPGZDut1XOwQcTcjtaQJEbTYa0KUQ+7Ta9KCNAO6GEhQGh/UpFYyO81ojairqWZZyiu8k3u5CHrVc8wv6ZZrFsbRJRwhF/zzMPaqqk71I+PYohRaMsGZwpZ/7igmqiSkRJC96+f/0AwKWpLaySHkNrTIC1alg5NyfGSUrAN7hjw6z4UmJs6I06huhfO4BD5wizdXjUpmROw6Wzfbm21GWb1pCoC315rSU3ruKm2/rB7bHtLfSbrW+ks3t1P106CTCE+Mnt//VtxjJlBOAHnS346jYOGhQosJ1Cd4G86Eb0QhL9JhUAKHWL8qUiqTdach+33Pm9FJykzE8m2OAjD0qkKdEy9WK5pJrI748YcfuiAC2fR8dY/HqdNrftcDSefI8pQewaDiW/FLGCjWCxFHXNPnKXb3gl8tYHM="
    matrix:
        - CONFIG_OPTS="--buildtype=debug" PREP_SCRIPT="scripts/travis-ci-prep-docker-ubuntu.sh" BASE_IMAGE="djdeath/gputop-travis-ci-ubuntu16.04-18.01.09"
        - CONFIG_OPTS="--buildtype=release" PREP_SCRIPT="scripts/travis-ci-prep-docker-ubuntu.sh" BASE_IMAGE="djdeath/gputop-travis-ci-ubuntu16.04-18.01.09"
        - CONFIG_OPTS="--buildtype=debug -Dnative_ui=true" PREP_SCRIPT="scripts/travis-ci-prep-docker-ubuntu.sh" BASE_IMAGE="djdeath/gputop-travis-ci-ubuntu16.04-18.01.09"
        - CONFIG_OPTS="--buildtype=release -Dnative_ui=true" PREP_SCRIPT="scripts/travis-ci-prep-docker-ubuntu.sh" BASE_IMAGE="djdeath/gputop-travis-ci-ubuntu16.04-18.01.09"
        - CONFIG_OPTS="--buildtype=debug --cross=scripts/meson-cross/emscripten-docker-debug.txt -Dwebui=true" PREP_SCRIPT="scripts/travis-ci-prep-docker-ubuntu.sh" BASE_IMAGE="djdeath/gputop-travis-ci-ubuntu16.04-18.01.09"
        - CONFIG_OPTS="--buildtype=release --cross=scripts/meson-cross/emscripten-docker-release.txt -Dwebui=true" PREP_SCRIPT="scripts/travis-ci-prep-docker-ubuntu.sh" BASE_IMAGE="djdeath/gputop-travis-ci-ubuntu16.04-18.01.09"
        - CONFIG_OPTS="--buildtype=debug" PREP_SCRIPT="scripts/travis-ci-prep-docker-centos.sh" BASE_IMAGE="djdeath/gputop-travis-ci-centos7-18.01.08"
        - CONFIG_OPTS="--buildtype=release" PREP_SCRIPT="scripts/travis-ci-prep-docker-centos.sh" BASE_IMAGE="djdeath/gputop-travis-ci-centos7-18.01.08"
        - CONFIG_OPTS="--buildtype=debug -Dnative_ui=true" PREP_SCRIPT="scripts/travis-ci-prep-docker-centos.sh" BASE_IMAGE="djdeath/gputop-travis-ci-centos7-18.01.08"
        - CONFIG_OPTS="--buildtype=release -Dnative_ui=true" PREP_SCRIPT="scripts/travis-ci-prep-docker-centos.sh" BASE_IMAGE="djdeath/gputop-travis-ci-centos7-18.01.08"


before_install:
    - docker pull $BASE_IMAGE
    - $PREP_SCRIPT $BASE_IMAGE final-travis-ci-image

script:
    - sudo docker run -t -i -v $TRAVIS_BUILD_DIR:/home/$USER/build -e TRAVIS_BUILD_DIR="/home/$USER/build" -e CONFIG_OPTS="$CONFIG_OPTS" final-travis-ci-image scripts/travis-ci-build.sh
    - sudo docker run -t -i -v $TRAVIS_BUILD_DIR:/home/$USER/build -e TRAVIS_BUILD_DIR="/home/$USER/build" -e CONFIG_OPTS="$CONFIG_OPTS" final-travis-ci-image scripts/travis-ci-test.sh

deploy:
    provider: script
    script: ./scripts/deploy-demo-site.sh
    skip_cleanup: true
    on:
        condition: $CONFIG_OPTS = "--buildtype=release --cross=scripts/meson-cross/emscripten-docker-release.txt -Dwebui=true"
        branch: imgui
